#!/bin/bash
# Pre-commit hook: format + build with unit tests

set -e

# Colours for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Colour

echo "Running pre-commit checks..."

# Configure Java
if command -v jenv >/dev/null 2>&1; then
    eval "$(jenv init -)"
fi

# 1. Format Java code with Spotless
echo ""
echo "Formatting Java code with Spotless..."

# Check if any Java files are staged
if git diff --cached --name-only --diff-filter=ACM | grep -q '\.java$'; then
    if ! make format; then
        echo -e "${RED}✗ Maven Spotless formatting failed${NC}"
        exit 1
    fi

    # Re-stage formatted files
    git diff --cached --name-only --diff-filter=ACM | grep '\.java$' | xargs git add

    echo -e "${GREEN}✓ Code formatted${NC}"
else
    echo "No Java files staged, skipping formatting"
fi

# 2. Build and run unit tests
echo ""
echo "Building and running tests..."
if ! make build; then
    echo -e "${RED}✗ Build or tests failed${NC}"
    echo "Fix the errors before committing"
    exit 1
fi
echo -e "${GREEN}✓ Build and tests successful${NC}"

echo -e "${GREEN}✓ Pre-commit checks passed${NC}"
exit 0
